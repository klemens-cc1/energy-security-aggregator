name: Daily Energy Security Digest

on:
  schedule:
    # GitHub Actions cron is UTC. 10:00 AM Atlanta is 14:00 UTC (EDT) or
    # 15:00 UTC (EST), so we trigger both and gate to local 10:00.
    - cron: "0 14 * * 5"
    - cron: "0 15 * * 5"
  workflow_dispatch:

jobs:
  schedule-gate:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.gate.outputs.should_run }}
    steps:
      - name: Determine whether this run should execute
        id: gate
        env:
          TZ: America/New_York
        run: |
          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "Manual trigger detected; allowing run."
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          local_time="$(date '+%H:%M %A %Z')"
          hour="$(date '+%H')"
          weekday="$(date '+%u')"
          echo "Current Atlanta local time: $local_time"

          if [ "$weekday" = "5" ] && [ "$hour" = "10" ]; then
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "Not Friday 10:00 AM in Atlanta; skipping duplicate UTC trigger."
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

  send-digest:
    needs: schedule-gate
    if: needs.schedule-gate.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Confirm filter loaded
        run: python -c "from filter import filter_and_categorize; print('filter OK')"

      - name: Run aggregator
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          FROM_ADDRESS: ${{ secrets.FROM_ADDRESS }}
          RECIPIENT_EMAILS: ${{ secrets.RECIPIENT_EMAILS }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python main.py

      - name: Notify on failure
        if: failure()
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          FROM_ADDRESS: ${{ secrets.FROM_ADDRESS }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
        run: |
          python - <<'EOF2'
          import os, smtplib
          from email.mime.text import MIMEText
          smtp_host = os.environ["SMTP_HOST"]
          smtp_port = int(os.environ.get("SMTP_PORT", 587))
          smtp_user = os.environ["SMTP_USER"]
          smtp_pass = os.environ["SMTP_PASS"]
          from_addr = os.environ.get("FROM_ADDRESS", smtp_user)
          admin = os.environ.get("ADMIN_EMAIL", from_addr)
          msg = MIMEText("The Energy Security Aggregator workflow failed. Check GitHub Actions for details:\nhttps://github.com/klemens-cc1/energy-security-aggregator/actions")
          msg["Subject"] = "⚠️ Energy Security Digest — workflow failed"
          msg["From"] = from_addr
          msg["To"] = admin
          with smtplib.SMTP(smtp_host, smtp_port) as s:
              s.starttls()
              s.login(smtp_user, smtp_pass)
              s.sendmail(from_addr, [admin], msg.as_string())
          print("Failure notification sent.")
          EOF2

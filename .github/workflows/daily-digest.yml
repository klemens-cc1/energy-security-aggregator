name: Daily Energy Security Digest

on:
  schedule:
    - cron: "0 13 * * 5"
  workflow_dispatch:

jobs:
  send-digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Confirm filter loaded
        run: python -c "from filter import filter_and_categorize; print('filter OK')"

      - name: Run aggregator
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          FROM_ADDRESS: ${{ secrets.FROM_ADDRESS }}
          RECIPIENT_EMAILS: ${{ secrets.RECIPIENT_EMAILS }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: python main.py

      - name: Notify on failure
        if: failure()
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          FROM_ADDRESS: ${{ secrets.FROM_ADDRESS }}
          RECIPIENT_EMAILS: ${{ secrets.RECIPIENT_EMAILS }}
        run: |
          python - <<'EOF'
          import os, smtplib
          from email.mime.text import MIMEText
          smtp_host = os.environ["SMTP_HOST"]
          smtp_port = int(os.environ.get("SMTP_PORT", 587))
          smtp_user = os.environ["SMTP_USER"]
          smtp_pass = os.environ["SMTP_PASS"]
          from_addr = os.environ.get("FROM_ADDRESS", smtp_user)
          recipients = [r.strip() for r in os.environ["RECIPIENT_EMAILS"].split(",")]
          msg = MIMEText("The Energy Security Aggregator workflow failed. Check GitHub Actions for details:\nhttps://github.com/klemens-cc1/energy-security-aggregator/actions")
          msg["Subject"] = "⚠️ Energy Security Digest — workflow failed"
          msg["From"] = from_addr
          msg["To"] = ", ".join(recipients)
          with smtplib.SMTP(smtp_host, smtp_port) as s:
              s.starttls()
              s.login(smtp_user, smtp_pass)
              s.sendmail(from_addr, recipients, msg.as_string())
          print("Failure notification sent.")
          EOF
